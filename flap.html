<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flap</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        html,
        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            /* outline: 1px solid red; */
            font-family: 'Press Start 2P', sans-serif;
        }

        #header {
            width: 100%;
            text-align: center;
            font-size: 2em;
        }
    </style>
</head>

<body>
    <div id="header">
        <div id="title">FlapJack</div>
    </div>
    <canvas id="canvas" width="431" height="768"></canvas>

    <script>
        const birdWidth = 51;
        const birdHeight = 36;
        const birdStartX = 50;
        const gravity = 3;
        const antiGravity = 3;
        const flapHeight = 55;
        const flapDuration = 10;

        const pipeWidth = 78;
        const pipeHeight = 480;
        // const pipeGap = birdHeight * 3;  // HARD MODE.
        const pipeGap = birdHeight * 5;
        const pipeYOffset = 200;
        const pipeSpeed = 2;

        let flapCount = 10;
        let flyHeight = (canvas.height / 2) - (birdHeight / 2);

        let pipePos = canvas.width;  // TODO: Rename to pipePosX OR considate for easier loop handling
        let pipePos2 = canvas.width + ((canvas.width / 2) + (pipeWidth / 2));
        let pipeYCenter = getNewPipeYCenter();  // TODO: Rename var to pipeYUpper and function to getNewPipeYUpper OR consolidate
        let pipeYCenter2 = getNewPipeYCenter();

        function getNewPipeYCenter() {
            return (
                (canvas.height / 2)  // TODO: Remove first and last operands -- they cancel out and are just noise.
                - Math.round(Math.random() * pipeGap)  // Then get random amount for the gap.
                - pipeHeight
            );
        }

        function loop() {
            // Background
            ctx.drawImage(img,
                0, 0,
                canvas.width, 768,
                0, 0,
                canvas.width, canvas.height
            );

            // Bird flight
            if (flapCount < flapDuration) {
                if (flyHeight > 0) {
                    flyHeight -= antiGravity;
                }
                flapCount++;
            }
            else if (flyHeight < canvas.height - birdHeight) {
                flyHeight += gravity;
            }
            // Bird
            ctx.drawImage(img,
                canvas.width + 1, 0,
                birdWidth, birdHeight,
                birdStartX, flyHeight,
                birdWidth, birdHeight
            );

            // TODO: Combine pipes for less copy/paste/etc. Maybe loop?
            // If not yet off the screen, scroll it along. Else, reset it to the right and get new random gap.
            if (pipePos > -pipeWidth) {
                pipePos -= pipeSpeed;
            }
            else {
                pipePos = canvas.width;
                pipeYCenter = getNewPipeYCenter();
            }
            // Upper pipe 1
            ctx.drawImage(img,
                canvas.width + 1, (birdHeight * 3) + 1,
                pipeWidth, pipeHeight,
                pipePos, pipeYCenter,
                pipeWidth, pipeHeight
            );
            // Lower pipe 1
            ctx.drawImage(img,
                canvas.width + pipeWidth + 1, (birdHeight * 3) + 1,
                pipeWidth, pipeHeight,
                pipePos, pipeHeight + pipeGap + pipeYCenter,
                pipeWidth, pipeHeight
            );

            // If not yet off the screen, scroll it along. Else, reset it to the right and get new random gap.
            if (pipePos2 > -pipeWidth) {
                pipePos2 -= pipeSpeed;
            }
            else {
                pipePos2 = canvas.width;
                pipeYCenter2 = getNewPipeYCenter();
            }
            // Upper pipe 2
            ctx.drawImage(img,
                canvas.width + 1, (birdHeight * 3) + 1,
                pipeWidth, pipeHeight,
                pipePos2, pipeYCenter2,
                pipeWidth, pipeHeight
            );
            // Lower pipe 2
            ctx.drawImage(img,
                canvas.width + pipeWidth + 1, (birdHeight * 3) + 1,
                pipeWidth, pipeHeight,
                pipePos2, pipeHeight + pipeGap + pipeYCenter2,
                pipeWidth, pipeHeight
            );

            window.requestAnimationFrame(loop);
        }

        let ctx = canvas.getContext('2d');
        const img = new Image();
        img.src = "flappy-bird-set.png";
        img.onload = loop;

        // Hitting the spacebar will make the bird flap.
        window.onkeydown = function (evt) {
            if (evt.code == "Space") {
                if (flyHeight > 0) flapCount = 0;
            }
        }

    </script>
</body>

</html>